{% extends 'layout.html' %}

{% block content %}
<h1>Servi√ßos</h1>

<!-- Bot√£o para acionar o modal de adicionar servi√ßo -->
<button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addServicoModal">
  Adicionar Novo Servi√ßo
</button>

<!-- Modal de Adicionar Servi√ßo -->
<div class="modal fade" id="addServicoModal" tabindex="-1" aria-labelledby="addServicoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addServicoModalLabel">Adicionar Novo Servi√ßo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('main.servicos') }}" method="post">
          <div class="mb-3">
            <label for="servico_descricao" class="form-label">Descri√ß√£o do Servi√ßo</label>
            <input type="text" class="form-control" id="servico_descricao" name="servico_descricao" required>
          </div>
          <div class="mb-3">
            <label for="aparelho" class="form-label">Aparelho</label>
            <input type="text" class="form-control" id="aparelho" name="aparelho">
          </div>

          <div class="mb-3">
            <label for="tipo" class="form-label">Tipo</label>
            <select class="form-select" id="tipo_servico" name="tipo" required>
              <option value="Manuten√ß√£o">Manuten√ß√£o</option>
              <option value="Venda de Aparelho">Venda de Aparelho</option>
            </select>
          </div>
          <div class="mb-3" id="custo_pecas_div">
            <label for="custo_pecas" class="form-label">Custo com Pe√ßas</label>
            <input type="number" step="0.01" class="form-control" id="custo_pecas" name="custo_pecas" value="">
          </div>

          <!-- ...dentro do modal de adicionar servi√ßo... -->
          <div class="mb-3" id="valor_dinamico_div">
            <label for="valor_dinamico" class="form-label" id="valor_dinamico_label">M√£o de Obra</label>
            <input type="number" step="0.01" class="form-control" id="valor_dinamico" name="mao_de_obra" value="">
          </div>

          <div class="mb-3" id="status_radios_div">
            <label class="form-label">Status</label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="status" id="status_iniciado" value="Iniciado"
                  checked>
                <label class="form-check-label" for="status_iniciado">Iniciado</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="status" id="status_finalizado" value="Finalizado">
                <label class="form-check-label" for="status_finalizado">Finalizado</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="forma_pagamento" class="form-label">Forma de Pagamento</label>
            <input type="text" class="form-control" id="forma_pagamento" name="forma_pagamento">
          </div>
          <div class="mb-3">
            <label for="cliente" class="form-label">Cliente</label>
            <input type="text" class="form-control" id="cliente" name="cliente">
          </div>

          <button type="submit" class="btn btn-primary">Salvar Servi√ßo</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- <script>
  $(document).ready(function () {
    function toggleValorDinamico() {
      const tipo = $('#tipo_servico').val();
      const label = $('#valor_dinamico_label');
      const input = $('#valor_dinamico');
      $('#custo_pecas_div').show();

      if (tipo === 'Manuten√ß√£o') {
        label.text('M√£o de Obra');
        input.attr('name', 'mao_de_obra');
        input.val('');
        $('#status_radios_div').show();
        $('#status_finalizado').prop('checked', false);
        $('#status_iniciado').prop('checked', true);
      } else if (tipo === 'Venda de Aparelho') {
        label.text('Pre√ßo do Aparelho');
        input.attr('name', 'preco_aparelho');
        input.val('');
        $('#status_radios_div').hide();
        $('#status_finalizado').prop('checked', true);
      }
    }

    $('#tipo_servico').on('change', toggleValorDinamico);
    toggleValorDinamico();
  });
</script> -->

<table class="table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Data/Hora</th>
      <th>Servi√ßo</th>
      <th>Aparelho</th>
      <th>Tipo</th>
      <th>Custo Pe√ßas</th>
      <th>M√£o de Obra</th>
      <th>Pre√ßo Aparelho</th>
      <th>Status</th>
      <th>Forma de Pagamento</th>
      <th>Cliente</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody>
    {% for servico in servicos %}
    <tr>
      <td>{{ servico.id }}</td>
      <td>{{ servico.data_hora.strftime('%d/%m/%Y %H:%M') }}</td>
      <td>{{ servico.servico_descricao }}</td>
      <td>{{ servico.aparelho or '-' }}</td>
      <td>{{ servico.tipo }}</td>
      <td>{{ servico.custo_pecas|round(2) }}</td>
      <td>{{ servico.mao_de_obra|round(2) }}</td>
      <td>{{ servico.preco_aparelho|round(2) }}</td>
      <td>
        <span class="badge {% if servico.status == 'Iniciado' %}bg-secondary{% else %}bg-success{% endif %}">
          {{ servico.status }}
        </span>
      </td>
      <td>{{ servico.forma_pagamento }}</td>
      <td>{{ servico.cliente }}</td>
      <td>
        <div class="d-flex gap-2 align-items-stretch">

          <form action="{{ url_for('main.imprimir', servico_id=servico.id) }}" method="post" class="w-100">
            <button type="submit" class="btn btn-sm btn-secondary w-100 h-100">üñ®Ô∏è Imprimir</button>
          </form>

          <form class="w-100">
            <button type="button" class="btn btn-warning btn-sm w-100 h-100" data-bs-toggle="modal"
              data-bs-target="#editServicoModal{{ servico.id }}">
              Editar
            </button>
          </form>

          <form action="{{ url_for('main.delete_servico', id=servico.id) }}" method="post"
            onsubmit="return confirm('Tem certeza que deseja deletar este servi√ßo?');" class="w-100">
            <button type="submit" class="btn btn-danger btn-sm w-100 h-100">Deletar</button>
          </form>

        </div>

      </td>

    </tr>

    <!-- Modal de Edi√ß√£o de Servi√ßo -->
    <div class="modal fade" id="editServicoModal{{ servico.id }}" tabindex="-1"
      aria-labelledby="editServicoModalLabel{{ servico.id }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editServicoModalLabel{{ servico.id }}">Editar Servi√ßo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form action="{{ url_for('main.edit_servico', id=servico.id) }}" method="post">
              <div class="mb-3">
                <label for="servico_descricao" class="form-label">Descri√ß√£o do Servi√ßo</label>
                <input type="text" class="form-control" name="servico_descricao" value="{{ servico.servico_descricao }}"
                  required>
              </div>
              <div class="mb-3">
                <label for="aparelho" class="form-label">Aparelho</label>
                <input type="text" class="form-control" name="aparelho" value="{{ servico.aparelho or '' }}">
              </div>
              <div class="mb-3">
                <label for="tipo" class="form-label">Tipo</label>
                <select class="form-select" name="tipo" id="edit_tipo_servico_{{ servico.id }}" required>
                  <option value="Manuten√ß√£o" {% if servico.tipo=='Manuten√ß√£o' %}selected{% endif %}>Manuten√ß√£o</option>
                  <option value="Venda de Aparelho" {% if servico.tipo=='Venda de Aparelho' %}selected{% endif %}>Venda
                    de Aparelho</option>
                </select>
              </div>
              <div class="mb-3" id="edit_custo_pecas_div_{{ servico.id }}">
                <label for="custo_pecas" class="form-label">Custo com Pe√ßas</label>
                <input type="number" step="0.01" class="form-control" name="custo_pecas"
                  value="{{ servico.custo_pecas }}">
              </div>
              <div class="mb-3" id="edit_mao_de_obra_div_{{ servico.id }}">
                <label for="mao_de_obra" class="form-label" id="edit_mao_de_obra_label_{{ servico.id }}">M√£o de
                  Obra</label>
                <input type="number" step="0.01" class="form-control" name="mao_de_obra"
                  value="{{ servico.mao_de_obra }}">
              </div>
              <div class="mb-3" id="edit_preco_aparelho_div_{{ servico.id }}" style="display:none;">
                <label for="preco_aparelho" class="form-label" id="edit_preco_aparelho_label_{{ servico.id }}">Pre√ßo do
                  Aparelho</label>
                <input type="number" step="0.01" class="form-control" name="preco_aparelho"
                  value="{{ servico.preco_aparelho }}">
              </div>

              <div class="mb-3" id="edit_status_radios_div_{{ servico.id }}">
                <label class="form-label">Status</label>
                <div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="status"
                      id="edit_status_iniciado_{{ servico.id }}" value="Iniciado" {% if servico.status=='Iniciado'
                      %}checked{% endif %}>
                    <label class="form-check-label" for="edit_status_iniciado_{{ servico.id }}">Iniciado</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="status"
                      id="edit_status_finalizado_{{ servico.id }}" value="Finalizado" {% if servico.status=='Finalizado'
                      %}checked{% endif %}>
                    <label class="form-check-label" for="edit_status_finalizado_{{ servico.id }}">Finalizado</label>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="edit_forma_pagamento_{{ servico.id }}" class="form-label">Forma de Pagamento</label>
                <input type="text" class="form-control" id="edit_forma_pagamento_{{ servico.id }}"
                  name="forma_pagamento" value="{{ servico.forma_pagamento or '' }}">
              </div>
              <div class="mb-3">
                <label for="edit_cliente_{{ servico.id }}" class="form-label">Cliente</label>
                <input type="text" class="form-control" id="edit_cliente_{{ servico.id }}" name="cliente"
                  value="{{ servico.cliente or '' }}">
              </div>
              <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    <script>
      function atualizarCamposServico(tipo, $label, $input, $radiosDiv, $finalizado, $iniciado) {
        $('#custo_pecas_div').show();
        if (tipo === 'Manuten√ß√£o') {
          $label.text('M√£o de Obra');
          $input.attr('name', 'mao_de_obra');
          $radiosDiv.show();
        } else if (tipo === 'Venda de Aparelho') {
          $label.text('Pre√ßo do Aparelho');
          $input.attr('name', 'preco_aparelho');
          $radiosDiv.hide();
          $finalizado.prop('checked', true);
        }
      }
    </script>
    <script>

      $(document).ready(function () {
        function atualizarAdicionar() {
          const tipo = $('#tipo_servico').val();
          atualizarCamposServico(
            tipo,
            $('#valor_dinamico_label'),
            $('#valor_dinamico'),
            $('#status_radios_div'),
            $('#status_finalizado'),
            $('#status_iniciado')
          );
        }
        $('#tipo_servico').on('change', atualizarAdicionar);
        atualizarAdicionar();
      });
    </script>



    <script>
      $(document).ready(function () {
        // Para todos os modais de edi√ß√£o de servi√ßo
        $('[id^="editServicoModal"]').on('shown.bs.modal', function () {
          const modal = $(this);
          const tipoSelect = modal.find('select[name="tipo"]');
          const maoDeObraDiv = modal.find('[id^="edit_mao_de_obra_div_"]');
          const precoAparelhoDiv = modal.find('[id^="edit_preco_aparelho_div_"]');
          const statusRadiosDiv = modal.find('[id^="edit_status_radios_div_"]');
          const maoDeObraLabel = modal.find('[id^="edit_mao_de_obra_label_"]');
          const precoAparelhoLabel = modal.find('[id^="edit_preco_aparelho_label_"]');
          const finalizado = modal.find('input[id^="edit_status_finalizado_"]');
          const iniciado = modal.find('input[id^="edit_status_iniciado_"]');

          function atualizarEditar() {
            const tipo = tipoSelect.val();
            if (tipo === 'Manuten√ß√£o') {
              maoDeObraDiv.show();
              precoAparelhoDiv.hide();
              maoDeObraLabel.text('M√£o de Obra');
              maoDeObraDiv.find('input').attr('name', 'mao_de_obra');
              precoAparelhoDiv.find('input').removeAttr('name');
              statusRadiosDiv.show();
            } else if (tipo === 'Venda de Aparelho') {
              maoDeObraDiv.hide();
              precoAparelhoDiv.show();
              precoAparelhoLabel.text('Pre√ßo do Aparelho');
              precoAparelhoDiv.find('input').attr('name', 'preco_aparelho');
              maoDeObraDiv.find('input').removeAttr('name');
              statusRadiosDiv.hide();
              finalizado.prop('checked', true);
            }
          }
          tipoSelect.on('change', atualizarEditar);
          atualizarEditar();
        });
      });
    </script>
  </tbody>
</table>
{% endblock %}