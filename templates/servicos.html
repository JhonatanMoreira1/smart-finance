{% extends 'layout.html' %}

{% block content %}
<h1>Servi√ßos</h1>

<!-- Bot√£o para acionar o modal de adicionar servi√ßo -->
<button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addServicoModal">
  Adicionar Novo Servi√ßo
</button>

<!-- Modal de Adicionar Servi√ßo (sem altera√ß√µes) -->
<div class="modal fade" id="addServicoModal" tabindex="-1" aria-labelledby="addServicoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addServicoModalLabel">Adicionar Novo Servi√ßo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('main.servicos') }}" method="post">
          <div class="mb-3">
            <label for="servico_descricao" class="form-label">Descri√ß√£o do Servi√ßo</label>
            <input type="text" class="form-control" id="servico_descricao" name="servico_descricao" required>
          </div>
          <div class="mb-3">
            <label for="aparelho" class="form-label">Aparelho</label>
            <input type="text" class="form-control" id="aparelho" name="aparelho">
          </div>
          <div class="mb-3">
            <label for="tipo_servico" class="form-label">Tipo</label>
            <select class="form-select" id="tipo_servico" name="tipo" required>
              <option value="Manuten√ß√£o">Manuten√ß√£o</option>
              <option value="Venda de Aparelho">Venda de Aparelho</option>
            </select>
          </div>
          <div class="mb-3" id="subtipo_venda_div" style="display:none;">
            <label class="form-label">Subtipo de Venda</label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="subtipo_venda" id="subtipo_reforma" value="Reforma" checked>
                <label class="form-check-label" for="subtipo_reforma">Reforma</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="subtipo_venda" id="subtipo_revenda" value="Revenda">
                <label class="form-check-label" for="subtipo_revenda">Revenda</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="custo_pecas" class="form-label">Custos e/ou pe√ßas</label>
            <input type="number" step="0.01" class="form-control" id="custo_pecas" name="custo_pecas">
          </div>
          <div class="mb-3" id="valor_dinamico_div">
            <label for="valor_dinamico" class="form-label" id="valor_dinamico_label">M√£o de Obra</label>
            <input type="number" step="0.01" class="form-control" id="valor_dinamico" name="mao_de_obra">
          </div>
          <div class="mb-3" id="status_radios_div">
            <label class="form-label">Status</label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="status" id="status_iniciado" value="Iniciado" checked>
                <label class="form-check-label" for="status_iniciado">Iniciado</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="status" id="status_finalizado" value="Finalizado">
                <label class="form-check-label" for="status_finalizado">Finalizado</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="forma_pagamento" class="form-label">Forma de Pagamento</label>
            <input type="text" class="form-control" id="forma_pagamento" name="forma_pagamento">
          </div>
          <div class="mb-3">
            <label for="cliente" class="form-label">Cliente</label>
            <input type="text" class="form-control" id="cliente" name="cliente">
          </div>
          <button type="submit" class="btn btn-primary">Salvar Servi√ßo</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Edi√ß√£o √öNICO (com a l√≥gica JS correta) -->
<div class="modal fade" id="editServicoModal" tabindex="-1" aria-labelledby="editServicoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editServicoModalLabel">Editar Servi√ßo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editServicoForm" method="post">
          <div class="mb-3">
            <label for="edit_servico_descricao" class="form-label">Descri√ß√£o do Servi√ßo</label>
            <input type="text" class="form-control" id="edit_servico_descricao" name="servico_descricao" required>
          </div>
          <div class="mb-3">
            <label for="edit_aparelho" class="form-label">Aparelho</label>
            <input type="text" class="form-control" id="edit_aparelho" name="aparelho">
          </div>
          <div class="mb-3">
            <label for="edit_tipo" class="form-label">Tipo</label>
            <select class="form-select" id="edit_tipo" name="tipo" required>
              <option value="Manuten√ß√£o">Manuten√ß√£o</option>
              <option value="Venda de Aparelho">Venda de Aparelho</option>
            </select>
          </div>
          <div class="mb-3" id="edit_subtipo_venda_div" style="display:none;">
            <label class="form-label">Subtipo de Venda</label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="subtipo_venda" id="edit_subtipo_reforma" value="Reforma" checked>
                <label class="form-check-label" for="edit_subtipo_reforma">Reforma</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="subtipo_venda" id="edit_subtipo_revenda" value="Revenda">
                <label class="form-check-label" for="edit_subtipo_revenda">Revenda</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="edit_custo_pecas" class="form-label">Custos e/ou pe√ßas</label>
            <input type="number" step="0.01" class="form-control" id="edit_custo_pecas" name="custo_pecas">
          </div>
          <div class="mb-3" id="edit_valor_dinamico_div">
            <label for="edit_valor_dinamico_label" class="form-label">M√£o de Obra</label>
            <input type="number" step="0.01" class="form-control" id="edit_valor_dinamico" name="mao_de_obra">
          </div>
          <div class="mb-3" id="edit_status_radios_div">
            <label class="form-label">Status</label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="status" id="edit_status_iniciado" value="Iniciado" checked>
                <label class="form-check-label" for="edit_status_iniciado">Iniciado</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="status" id="edit_status_finalizado" value="Finalizado">
                <label class="form-check-label" for="edit_status_finalizado">Finalizado</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="edit_forma_pagamento" class="form-label">Forma de Pagamento</label>
            <input type="text" class="form-control" id="edit_forma_pagamento" name="forma_pagamento">
          </div>
          <div class="mb-3">
            <label for="edit_cliente" class="form-label">Cliente</label>
            <input type="text" class="form-control" id="edit_cliente" name="cliente">
          </div>
          <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<table class="table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Data/Hora</th>
      <th>Servi√ßo</th>
      <th>Aparelho</th>
      <th>Tipo</th>
      <th>Custos e pe√ßas</th>
      <th>M√£o de Obra</th>
      <th>Pre√ßo Aparelho</th>
      <th>Status</th>
      <th>Forma de Pagamento</th>
      <th>Cliente</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody id="servicos-table-body">
    {% for servico in servicos %}
    <tr>
      <td>{{ servico.id }}</td>
      <td>{{ servico.data_hora | localtime }}</td>
      <td>{{ servico.servico_descricao.replace('[REVENDA]', '') }}</td>
      <td>{{ servico.aparelho or '-' }}</td>
      <td>{{ servico.tipo }}</td>
      <td>R$ {{ servico.custo_pecas|round(2) }}</td>
      <td>R$ {{ servico.mao_de_obra|round(2) }}</td>
      <td>R$ {{ servico.preco_aparelho|round(2) }}</td>
      <td>
        <span class="badge {% if servico.status == 'Iniciado' %}bg-secondary{% else %}bg-success{% endif %}">
          {{ servico.status }}
        </span>
      </td>
      <td>{{ servico.forma_pagamento or '' }}</td>
      <td>{{ servico.cliente or '' }}</td>
      <td>
        <div class="d-flex gap-2 align-items-stretch">
          <form class="w-100">
          <button type="button" class="btn btn-light btn-sm w-100 h-100 border border-dark" onclick="imprimirNota({{ servico.id }})">üñ®Ô∏èImprimir</button>
          </form>
          <form class="w-100">
                  <button type="button" class="btn btn-warning btn-sm w-100 h-100" onclick="openEditModal({{ servico.id }})">Editar</button>
                  </form>
          <form action="{{ url_for('main.delete_servico', id=servico.id) }}" method="post" onsubmit="return confirm('Tem certeza?');" class="w-100">
            <button type="submit" class="btn btn-danger btn-sm w-100 h-100">Deletar</button>
          </form>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="text-center my-4">
  {% if total_servicos > 20 %}
  <button id="ver-mais-servicos-btn" class="btn btn-secondary">Ver mais</button>
  {% endif %}
</div>

<!-- SCRIPTS UNIFICADOS E CORRIGIDOS -->
<script>
// Fun√ß√£o para imprimir nota (sem altera√ß√µes)
function imprimirNota(servicoId) {
  const url = `/nota_servico/${servicoId}`;
  window.open(url, "_blank", "width=350,height=500");
}

// Fun√ß√£o para abrir e preencher o modal de edi√ß√£o
function openEditModal(servicoId) {
  fetch(`/api/servico/${servicoId}`)
    .then(response => response.json())
    .then(data => {
      $('#editServicoForm').attr('action', `/edit_servico/${servicoId}`);
      $('#edit_servico_descricao').val(data.servico_descricao || '');
      $('#edit_aparelho').val(data.aparelho || '');
      $('#edit_tipo').val(data.tipo || 'Manuten√ß√£o');
      $('#edit_custo_pecas').val(data.custo_pecas || '');
      $('#edit_forma_pagamento').val(data.forma_pagamento || '');
      $('#edit_cliente').val(data.cliente || '');

      // Preenche o valor din√¢mico corretamente
      if (data.tipo === 'Venda de Aparelho') {
        $('#edit_valor_dinamico').val(data.preco_aparelho || '');
      } else {
        $('#edit_valor_dinamico').val(data.mao_de_obra || '');
      }

      // Ajusta o status
      if (data.status === 'Finalizado') {
        $('#edit_status_finalizado').prop('checked', true);
      } else {
        $('#edit_status_iniciado').prop('checked', true);
      }

      // Ajusta o subtipo de venda
      if (data.servico_descricao && data.servico_descricao.includes('[REVENDA]')) {
        $('#edit_subtipo_revenda').prop('checked', true);
      } else {
        $('#edit_subtipo_reforma').prop('checked', true);
      }

      // Dispara o 'change' para ajustar a visibilidade dos campos no modal de edi√ß√£o
      $('#edit_tipo').trigger('change');

      // Mostra o modal
      const editModal = new bootstrap.Modal(document.getElementById('editServicoModal'));
      editModal.show();
    });
}

// L√≥gica que roda quando a p√°gina carrega
$(document).ready(function () {
  // --- L√≥gica para o Modal de ADICIONAR ---
  $('#tipo_servico').on('change', function () {
    const tipo = $(this).val();
    const subtipoDiv = $('#subtipo_venda_div');
    const valorDinamicoLabel = $('#valor_dinamico_label');
    const valorDinamicoInput = $('#valor_dinamico');
    const statusDiv = $('#status_radios_div');

    if (tipo === 'Venda de Aparelho') {
      subtipoDiv.show();
      valorDinamicoLabel.text('Pre√ßo do Aparelho');
      valorDinamicoInput.attr('name', 'preco_aparelho');
      statusDiv.hide();
      $('#status_finalizado').prop('checked', true);
    } else {
      subtipoDiv.hide();
      valorDinamicoLabel.text('M√£o de Obra');
      valorDinamicoInput.attr('name', 'mao_de_obra');
      statusDiv.show();
      $('#status_iniciado').prop('checked', true);
    }
  }).trigger('change');

  // --- L√≥gica para o Modal de EDITAR ---
  $('#edit_tipo').on('change', function () {
    const tipo = $(this).val();
    const subtipoDiv = $('#edit_subtipo_venda_div');
    const valorDinamicoLabel = $('#edit_valor_dinamico_label');
    const valorDinamicoInput = $('#edit_valor_dinamico');
    const statusDiv = $('#edit_status_radios_div');

    if (tipo === 'Venda de Aparelho') {
      subtipoDiv.show();
      valorDinamicoLabel.text('Pre√ßo do Aparelho');
      valorDinamicoInput.attr('name', 'preco_aparelho');
      statusDiv.hide();
    } else {
      subtipoDiv.hide();
      valorDinamicoLabel.text('M√£o de Obra');
      valorDinamicoInput.attr('name', 'mao_de_obra');
      statusDiv.show();
    }
  });

  // --- L√≥gica do "Ver Mais" ---
  const verMaisBtn = document.getElementById('ver-mais-servicos-btn');
  const totalServicos = {{ total_servicos }};

  if (verMaisBtn) {
    verMaisBtn.addEventListener('click', function () {
      const tbody = document.getElementById('servicos-table-body');
      const currentOffset = tbody.children.length;

      fetch(`/api/servicos?offset=${currentOffset}`)
        .then(response => response.json())
        .then(data => {
          data.forEach(servico => {
            const row = document.createElement('tr');
            
            // --- CORRE√á√ÉO NA FORMATA√á√ÉO DA DATA ---
            const dataObj = new Date(servico.data_hora);
            const dia = String(dataObj.getDate()).padStart(2, '0');
            const mes = String(dataObj.getMonth() + 1).padStart(2, '0'); // M√™s √© base 0
            const ano = dataObj.getFullYear();
            const hora = String(dataObj.getHours()).padStart(2, '0');
            const minuto = String(dataObj.getMinutes()).padStart(2, '0');
            const dataFormatada = `${dia}/${mes}/${ano} ${hora}:${minuto}`;
            row.innerHTML = `
              <td>${servico.id}</td>
              <td>${dataFormatada}</td>
              <td>${servico.servico_descricao.replace('[REVENDA]', '')}</td>
              <td>${servico.aparelho || '-'}</td>
              <td>${servico.tipo}</td>
              <td>R$ ${(servico.custo_pecas || 0).toFixed(2)}</td>
              <td>R$ ${(servico.mao_de_obra || 0).toFixed(2)}</td>
              <td>R$ ${(servico.preco_aparelho || 0).toFixed(2)}</td>
              <td><span class="badge ${servico.status === 'Iniciado' ? 'bg-secondary' : 'bg-success'}">${servico.status}</span></td>
              <td>${servico.forma_pagamento || ''}</td>
              <td>${servico.cliente || ''}</td>
              <td>
                
                
                <div class="d-flex gap-2 align-items-stretch">
                  <form class="w-100">
                  <button type="button" class="btn btn-light btn-sm w-100 h-100 border border-dark" onclick="imprimirNota(${servico.id})">üñ®Ô∏èImprimir</button>
                   </form>
                  <form class="w-100">
                  <button type="button" class="btn btn-warning btn-sm w-100 h-100" onclick="openEditModal(${servico.id})">Editar</button>
                  </form>
                  <form class="w-100" action="/delete_servico/${servico.id}" method="post" onsubmit="return confirm('Tem certeza?');">
                    <button type="submit" class="btn btn-danger btn-sm w-100 h-100">Deletar</button>
                  </form>
                </div>
              </td>
            `;
            tbody.appendChild(row);
          });

          if (tbody.children.length >= totalServicos) {
            verMaisBtn.style.display = 'none';
          }
        });
    });
  }
});
</script>
{% endblock %}