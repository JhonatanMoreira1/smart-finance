{% extends 'layout.html' %}

{% block content %}
<h1>Servi√ßos</h1>

<!-- Bot√£o para acionar o modal de adicionar servi√ßo -->
<button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addServicoModal">
  Adicionar Novo Servi√ßo
</button>

<!-- Modal de Adicionar Servi√ßo -->
<div class="modal fade" id="addServicoModal" tabindex="-1" aria-labelledby="addServicoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addServicoModalLabel">Adicionar Novo Servi√ßo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('main.servicos') }}" method="post">
          <div class="mb-3">
            <label for="servico_descricao" class="form-label">Descri√ß√£o do Servi√ßo</label>
            <input type="text" class="form-control" id="servico_descricao" name="servico_descricao" required>
          </div>
          <div class="mb-3">
            <label for="aparelho" class="form-label">Aparelho</label>
            <input type="text" class="form-control" id="aparelho" name="aparelho">
          </div>

          <div class="mb-3">
            <label for="tipo" class="form-label">Tipo</label>
            <select class="form-select" id="tipo_servico" name="tipo" required>
              <option value="Manuten√ß√£o">Manuten√ß√£o</option>
              <option value="Venda de Aparelho">Venda de Aparelho</option>
            </select>
          </div>

          <div class="mb-3" id="subtipo_venda_div" style="display:none;">
            <label class="form-label">Subtipo de Venda</label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="subtipo_venda" id="subtipo_reforma" value="Reforma"
                  checked>
                <label class="form-check-label" for="subtipo_reforma">Reforma</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="subtipo_venda" id="subtipo_revenda" value="Revenda">
                <label class="form-check-label" for="subtipo_revenda">Revenda</label>
              </div>
            </div>
          </div>

          <div class="mb-3" id="custo_pecas_div">
            <label for="custo_pecas" class="form-label">Custos e/ou pe√ßas</label>
            <input type="number" step="0.01" class="form-control" id="custo_pecas" name="custo_pecas" value="">
          </div>

          <div class="mb-3" id="valor_dinamico_div">
            <label for="valor_dinamico" class="form-label" id="valor_dinamico_label">M√£o de Obra</label>
            <input type="number" step="0.01" class="form-control" id="valor_dinamico" name="mao_de_obra" value="">
          </div>

          <div class="mb-3" id="status_radios_div">
            <label class="form-label">Status</label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="status" id="status_iniciado" value="Iniciado"
                  checked>
                <label class="form-check-label" for="status_iniciado">Iniciado</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="status" id="status_finalizado" value="Finalizado">
                <label class="form-check-label" for="status_finalizado">Finalizado</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="forma_pagamento" class="form-label">Forma de Pagamento</label>
            <input type="text" class="form-control" id="forma_pagamento" name="forma_pagamento">
          </div>
          <div class="mb-3">
            <label for="cliente" class="form-label">Cliente</label>
            <input type="text" class="form-control" id="cliente" name="cliente">
          </div>

          <button type="submit" class="btn btn-primary">Salvar Servi√ßo</button>
        </form>
      </div>
    </div>
  </div>
</div>

<table class="table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Data/Hora</th>
      <th>Servi√ßo</th>
      <th>Aparelho</th>
      <th>Tipo</th>
      <th>Custos e pe√ßas</th>
      <th>M√£o de Obra</th>
      <th>Pre√ßo Aparelho</th>
      <th>Status</th>
      <th>Forma de Pagamento</th>
      <th>Cliente</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody>
    {% for servico in servicos %}
    <tr>
      <td>{{ servico.id }}</td>
      <td>{{ servico.data_hora | localtime }}</td>
      <td>{{ servico.servico_descricao.replace('[REVENDA]', '') }}</td>
      <td>{{ servico.aparelho or '-' }}</td>
      <td>{{ servico.tipo }}</td>
      <td>{{ servico.custo_pecas|round(2) }}</td>
      <td>{{ servico.mao_de_obra|round(2) }}</td>
      <td>{{ servico.preco_aparelho|round(2) }}</td>
      <td>
        <span class="badge {% if servico.status == 'Iniciado' %}bg-secondary{% else %}bg-success{% endif %}">
          {{ servico.status }}
        </span>
      </td>
      <td>{{ servico.forma_pagamento }}</td>
      <td>{{ servico.cliente }}</td>
      <td>
        <div class="d-flex gap-2 align-items-stretch">

          <form class="w-100">
            <button type="button" class="btn btn-light btn-sm w-100 h-100 border border-dark"
              onclick="imprimirNota({{ servico.id }})">üñ®Ô∏èImprimir</button>
          </form>


          <form class="w-100">
            <button type="button" class="btn btn-warning btn-sm w-100 h-100" data-bs-toggle="modal"
              data-bs-target="#editServicoModal{{ servico.id }}">
              Editar
            </button>
          </form>

          <form action="{{ url_for('main.delete_servico', id=servico.id) }}" method="post"
            onsubmit="return confirm('Tem certeza que deseja deletar este servi√ßo?');" class="w-100">
            <button type="submit" class="btn btn-danger btn-sm w-100 h-100">Deletar</button>
          </form>

        </div>

      </td>

    </tr>

    <!-- Modal de Edi√ß√£o de Servi√ßo -->
    <div class="modal fade" id="editServicoModal{{ servico.id }}" tabindex="-1"
      aria-labelledby="editServicoModalLabel{{ servico.id }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editServicoModalLabel{{ servico.id }}">Editar Servi√ßo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form action="{{ url_for('main.edit_servico', id=servico.id) }}" method="post">
              <div class="mb-3">
                <label for="servico_descricao" class="form-label">Descri√ß√£o do Servi√ßo</label>
                <input type="text" class="form-control" name="servico_descricao"
                  value="{{ servico.servico_descricao.replace('[REVENDA]', '') }}" required>
              </div>
              <div class="mb-3">
                <label for="aparelho" class="form-label">Aparelho</label>
                <input type="text" class="form-control" name="aparelho" value="{{ servico.aparelho or '' }}">
              </div>
              <div class="mb-3">
                <label for="tipo" class="form-label">Tipo</label>
                <select class="form-select edit_tipo_servico" name="tipo" data-servico-id="{{ servico.id }}" required>
                  <option value="Manuten√ß√£o" {% if servico.tipo=='Manuten√ß√£o' %}selected{% endif %}>Manuten√ß√£o</option>
                  <option value="Venda de Aparelho" {% if servico.tipo=='Venda de Aparelho' %}selected{% endif %}>Venda
                    de Aparelho</option>
                </select>
              </div>

              <div class="mb-3 edit_subtipo_venda_div" style="display:none;" data-servico-id="{{ servico.id }}">
                <label class="form-label">Subtipo de Venda</label>
                <div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="subtipo_venda_{{ servico.id }}"
                      id="edit_subtipo_reforma_{{ servico.id }}" value="Reforma" {% if not
                      servico.servico_descricao.startswith('[REVENDA]') %}checked{% endif %}>
                    <label class="form-check-label" for="edit_subtipo_reforma_{{ servico.id }}">Reforma</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="subtipo_venda_{{ servico.id }}"
                      id="edit_subtipo_revenda_{{ servico.id }}" value="Revenda" {% if
                      servico.servico_descricao.startswith('[REVENDA]') %}checked{% endif %}>
                    <label class="form-check-label" for="edit_subtipo_revenda_{{ servico.id }}">Revenda</label>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="custo_pecas" class="form-label">Custos e/ou pe√ßas</label>
                <input type="number" step="0.01" class="form-control" name="custo_pecas"
                  value="{{ servico.custo_pecas }}">
              </div>
              <div class="mb-3 edit_mao_de_obra_div" data-servico-id="{{ servico.id }}">
                <label for="mao_de_obra" class="form-label">M√£o de
                  Obra</label>
                <input type="number" step="0.01" class="form-control" name="mao_de_obra"
                  value="{{ servico.mao_de_obra }}">
              </div>
              <div class="mb-3 edit_preco_aparelho_div" style="display:none;" data-servico-id="{{ servico.id }}">
                <label for="preco_aparelho" class="form-label">Pre√ßo do
                  Aparelho</label>
                <input type="number" step="0.01" class="form-control" name="preco_aparelho"
                  value="{{ servico.preco_aparelho }}">
              </div>

              <div class="mb-3 edit_status_radios_div" data-servico-id="{{ servico.id }}">
                <label class="form-label">Status</label>
                <div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="status"
                      id="edit_status_iniciado_{{ servico.id }}" value="Iniciado" {% if servico.status=='Iniciado'
                      %}checked{% endif %}>
                    <label class="form-check-label" for="edit_status_iniciado_{{ servico.id }}">Iniciado</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="status"
                      id="edit_status_finalizado_{{ servico.id }}" value="Finalizado" {% if servico.status=='Finalizado'
                      %}checked{% endif %}>
                    <label class="form-check-label" for="edit_status_finalizado_{{ servico.id }}">Finalizado</label>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="edit_forma_pagamento_{{ servico.id }}" class="form-label">Forma de Pagamento</label>
                <input type="text" class="form-control" id="edit_forma_pagamento_{{ servico.id }}"
                  name="forma_pagamento" value="{{ servico.forma_pagamento or '' }}">
              </div>
              <div class="mb-3">
                <label for="edit_cliente_{{ servico.id }}" class="form-label">Cliente</label>
                <input type="text" class="form-control" id="edit_cliente_{{ servico.id }}" name="cliente"
                  value="{{ servico.cliente or '' }}">
              </div>
              <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    <script>
      function imprimirNota(servicoId) {
        const url = `/nota_servico/${servicoId}`;
        const janela = window.open(url, "_blank", "width=350,height=500");
      }

      $(document).ready(function () {
        // --- L√≥gica para o Modal de Adicionar ---
        $('#tipo_servico').on('change', function () {
          const tipo = $(this).val();
          const subtipoDiv = $('#subtipo_venda_div');
          const valorDinamicoDiv = $('#valor_dinamico_div');
          const valorDinamicoLabel = $('#valor_dinamico_label');
          const valorDinamicoInput = $('#valor_dinamico');
          const statusDiv = $('#status_radios_div');

          if (tipo === 'Venda de Aparelho') {
            subtipoDiv.show();
            valorDinamicoLabel.text('Pre√ßo do Aparelho');
            valorDinamicoInput.attr('name', 'preco_aparelho');
            statusDiv.hide();
            $('#status_finalizado').prop('checked', true);
          } else {
            subtipoDiv.hide();
            valorDinamicoLabel.text('M√£o de Obra');
            valorDinamicoInput.attr('name', 'mao_de_obra');
            statusDiv.show();
            $('#status_iniciado').prop('checked', true);
          }
        }).trigger('change');

        // --- L√≥gica para os Modais de Edi√ß√£o ---
        $('.edit_tipo_servico').on('change', function () {
          const servicoId = $(this).data('servico-id');
          const tipo = $(this).val();
          const subtipoDiv = $(`.edit_subtipo_venda_div[data-servico-id='${servicoId}']`);
          const maoDeObraDiv = $(`.edit_mao_de_obra_div[data-servico-id='${servicoId}']`);
          const precoAparelhoDiv = $(`.edit_preco_aparelho_div[data-servico-id='${servicoId}']`);
          const statusDiv = $(`.edit_status_radios_div[data-servico-id='${servicoId}']`);

          if (tipo === 'Venda de Aparelho') {
            subtipoDiv.show();
            maoDeObraDiv.hide();
            precoAparelhoDiv.show();
            precoAparelhoDiv.find('input').attr('name', 'preco_aparelho');
            maoDeObraDiv.find('input').removeAttr('name');
            statusDiv.hide();
            $(`#edit_status_finalizado_${servicoId}`).prop('checked', true);
          } else {
            subtipoDiv.hide();
            maoDeObraDiv.show();
            precoAparelhoDiv.hide();
            maoDeObraDiv.find('input').attr('name', 'mao_de_obra');
            precoAparelhoDiv.find('input').removeAttr('name');
            statusDiv.show();
          }
        });

        // Dispara o evento 'change' para todos os modais de edi√ß√£o ao carregar a p√°gina
        // para garantir que o estado inicial esteja correto.
        $('.edit_tipo_servico').trigger('change');
      });
    </script>
  </tbody>
</table>
{% endblock %}