{% extends 'layout.html' %}

{% block content %}
<h1>Serviços</h1>

<!-- Botão para acionar o modal de adicionar serviço -->
<button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addServicoModal">
  Adicionar Novo Serviço
</button>

<!-- Modal de Adicionar Serviço -->
<div class="modal fade" id="addServicoModal" tabindex="-1" aria-labelledby="addServicoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addServicoModalLabel">Adicionar Novo Serviço</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('main.servicos') }}" method="post">
          <div class="mb-3">
            <label for="servico_descricao" class="form-label">Descrição do Serviço</label>
            <input type="text" class="form-control" id="servico_descricao" name="servico_descricao" required>
          </div>
          <div class="mb-3">
            <label for="aparelho" class="form-label">Aparelho</label>
            <input type="text" class="form-control" id="aparelho" name="aparelho">
          </div>

          <div class="mb-3">
            <label for="tipo" class="form-label">Tipo</label>
            <select class="form-select" id="tipo_servico" name="tipo" required>
              <option value="Manutenção">Manutenção</option>
              <option value="Venda de Aparelho">Venda de Aparelho</option>
            </select>
          </div>

          <div class="mb-3" id="subtipo_venda_div" style="display:none;">
            <label class="form-label">Subtipo de Venda</label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="subtipo_venda" id="subtipo_reforma" value="Reforma"
                  checked>
                <label class="form-check-label" for="subtipo_reforma">Reforma</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="subtipo_venda" id="subtipo_revenda" value="Revenda">
                <label class="form-check-label" for="subtipo_revenda">Revenda</label>
              </div>
            </div>
          </div>

          <div class="mb-3" id="custo_pecas_div">
            <label for="custo_pecas" class="form-label">Custos e/ou peças</label>
            <input type="number" step="0.01" class="form-control" id="custo_pecas" name="custo_pecas" value="">
          </div>

          <div class="mb-3" id="valor_dinamico_div">
            <label for="valor_dinamico" class="form-label" id="valor_dinamico_label">Mão de Obra</label>
            <input type="number" step="0.01" class="form-control" id="valor_dinamico" name="mao_de_obra" value="">
          </div>

          <div class="mb-3" id="status_radios_div">
            <label class="form-label">Status</label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="status" id="status_iniciado" value="Iniciado"
                  checked>
                <label class="form-check-label" for="status_iniciado">Iniciado</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="status" id="status_finalizado" value="Finalizado">
                <label class="form-check-label" for="status_finalizado">Finalizado</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="forma_pagamento" class="form-label">Forma de Pagamento</label>
            <input type="text" class="form-control" id="forma_pagamento" name="forma_pagamento">
          </div>
          <div class="mb-3">
            <label for="cliente" class="form-label">Cliente</label>
            <input type="text" class="form-control" id="cliente" name="cliente">
          </div>

          <button type="submit" class="btn btn-primary">Salvar Serviço</button>
        </form>
      </div>
    </div>
  </div>
</div>

<table class="table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Data/Hora</th>
      <th>Serviço</th>
      <th>Aparelho</th>
      <th>Tipo</th>
      <th>Custos e peças</th>
      <th>Mão de Obra</th>
      <th>Preço Aparelho</th>
      <th>Status</th>
      <th>Forma de Pagamento</th>
      <th>Cliente</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody id="service-list">
    {% include 'partials/_servicos_lista.html' %}
  </tbody>
</table>

<div id="modal-container">
    {% include 'partials/_servicos_modals.html' %}
</div>

{% if pagination.has_next %}
<div class="text-center my-4">
    <button id="ver-mais-btn" class="btn btn-secondary" data-next-page="{{ pagination.next_num }}">Ver Mais</button>
</div>
{% endif %}

<script>
function imprimirNota(servicoId) {
    const url = `/nota_servico/${servicoId}`;
    const janela = window.open(url, "_blank", "width=350,height=500");
}

$(document).ready(function () {
    // --- Lógica para o Modal de Adicionar ---
    function updateDescricao() {
        const tipo = $('#tipo_servico').val();
        const subtipo = $('input[name="subtipo_venda"]:checked').val();
        const descricaoInput = $('#servico_descricao');

        if (tipo === 'Venda de Aparelho') {
            if (subtipo === 'Revenda') {
                descricaoInput.val('Revenda de Aparelho');
            } else {
                descricaoInput.val('Venda de Aparelho');
            }
        } else {
            descricaoInput.val('');
        }
    }

    $('#tipo_servico').on('change', function () {
      const tipo = $(this).val();
      const subtipoDiv = $('#subtipo_venda_div');
      const valorDinamicoLabel = $('#valor_dinamico_label');
      const valorDinamicoInput = $('#valor_dinamico');
      const statusDiv = $('#status_radios_div');

      if (tipo === 'Venda de Aparelho') {
        subtipoDiv.show();
        valorDinamicoLabel.text('Preço do Aparelho');
        valorDinamicoInput.attr('name', 'preco_aparelho');
        statusDiv.hide();
        $('#status_finalizado').prop('checked', true);
      } else {
        subtipoDiv.hide();
        valorDinamicoLabel.text('Mão de Obra');
        valorDinamicoInput.attr('name', 'mao_de_obra');
        statusDiv.show();
        $('#status_iniciado').prop('checked', true);
      }
      updateDescricao();
    }).trigger('change');

    $('input[name="subtipo_venda"]').on('change', updateDescricao);

    // --- LÓGICA REATORADA PARA MODAIS DE EDIÇÃO (COM DELEGAÇÃO DE EVENTOS) ---
    $('#modal-container').on('change', '.edit_tipo_servico', function () {
      const servicoId = $(this).data('servico-id');
      const tipo = $(this).val();
      const subtipoDiv = $(`.edit_subtipo_venda_div[data-servico-id='${servicoId}']`);
      const maoDeObraDiv = $(`.edit_mao_de_obra_div[data-servico-id='${servicoId}']`);
      const precoAparelhoDiv = $(`.edit_preco_aparelho_div[data-servico-id='${servicoId}']`);
      const statusDiv = $(`.edit_status_radios_div[data-servico-id='${servicoId}']`);

      if (tipo === 'Venda de Aparelho') {
        subtipoDiv.show();
        maoDeObraDiv.hide();
        precoAparelhoDiv.show();
        precoAparelhoDiv.find('input').attr('name', 'preco_aparelho');
        maoDeObraDiv.find('input').removeAttr('name');
        statusDiv.hide();
        $(`#edit_status_finalizado_${servicoId}`).prop('checked', true);
      } else {
        subtipoDiv.hide();
        maoDeObraDiv.show();
        precoAparelhoDiv.hide();
        maoDeObraDiv.find('input').attr('name', 'mao_de_obra');
        precoAparelhoDiv.find('input').removeAttr('name');
        statusDiv.show();
      }
    });

    // Dispara o evento change para os modais que já existem na página inicial
    $('.edit_tipo_servico').trigger('change');

    // --- Lógica do "Ver Mais" ---
    $('#ver-mais-btn').on('click', function() {
        var button = $(this);
        var nextPage = button.data('next-page');
        var url = `{{ url_for('main.servicos') }}?page=${nextPage}`;

        $.getJSON(url, function(data) {
            if (data.table_html.trim() !== '') {
                $('#service-list').append(data.table_html);
                $('#modal-container').append(data.modals_html);
                // Dispara o evento change para os seletores dos novos modais carregados
                $('#modal-container .edit_tipo_servico').trigger('change');
                button.data('next-page', nextPage + 1);
            }

            if (!data.has_next) {
                button.hide();
            }
        });
    });
});
</script>

{% endblock %}